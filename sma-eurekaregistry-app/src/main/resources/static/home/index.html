<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Service Console</title>
    <link rel="stylesheet" href="styles.css" />
</head>

<body>
<a class="skip-link" href="#main">Skip to content</a>

<div class="app">
    <aside class="sidebar" aria-label="Always visible navigation">
        <div class="brand">
            <div class="logo" aria-hidden="true"></div>
            <div>
                <h1>Service Console</h1>
                <p>Navigation stays visible</p>
            </div>
        </div>

        <div class="navtitle">Main</div>
        <div class="navlist">
            <a class="navlink" href="#home" data-title="Home" data-inframe="home">
                <span class="icon" aria-hidden="true"></span>
                Home
            </a>

            <a class="navlink" href="/" data-title="Eureka Dashboard" data-inframe="url">
                <span class="icon" aria-hidden="true"></span>
                Eureka Dashboard
            </a>

            <!-- Bitrix cannot be iframed due to CSP frame-ancestors 'self' -->
            <a class="navlink" href="https://b24-pp3j32.bitrix24.in/~Yr03Z" data-title="Task Management" data-inframe="blocked">
                <span class="icon" aria-hidden="true"></span>
                Task Management
            </a>
        </div>

        <div class="navtitle">Info</div>
        <div class="navlist">
            <a class="navlink" href="/actuator/health" data-title="Actuator Health" data-inframe="url">
                <span class="icon" aria-hidden="true"></span>
                Actuator Health
            </a>

            <a class="navlink" href="/actuator" data-title="Actuator Root" data-inframe="url">
                <span class="icon" aria-hidden="true"></span>
                Actuator Root
            </a>

            <!-- Styled Eureka view (recommended) -->
            <a class="navlink" href="#eurekaStyled" data-title="Eureka Apps (Styled)" data-inframe="eurekaStyled">
                <span class="icon" aria-hidden="true"></span>
                Eureka Apps (Styled)
            </a>

            <!-- Raw Eureka Apps (original) -->
            <a class="navlink" href="/eureka/apps" data-title="Eureka Apps (Raw)" data-inframe="url">
                <span class="icon" aria-hidden="true"></span>
                Eureka Apps (Raw)
            </a>
        </div>

        <div class="pill" title="Local environment status">
            <span class="dot" aria-hidden="true"></span>
            Local console ready
        </div>

        <div style="margin-top: 12px; color: var(--muted); font-size: 12px; line-height: 1.45;">
            Tip: If you want <b>/home/</b> to work (instead of <b>/home/index.html</b>),
            add a small redirect controller. Otherwise, link directly to <b>/home/index.html</b>.
        </div>
    </aside>

    <main id="main" role="main" aria-label="Content frame">
        <div class="contentHeader" role="region" aria-label="Frame header">
            <div>
                <div class="title" id="frameTitle">Home</div>
                <div class="subtitle" id="frameSubtitle">Welcome screen</div>
            </div>

            <div class="toolbar" aria-label="Frame toolbar">
                <button class="toolbtn" type="button" id="openNewTabBtn" title="Open current frame URL in a new tab">
                    ↗ Open in new tab
                </button>
                <button class="toolbtn" type="button" id="reloadBtn" title="Reload the frame">
                    ↻ Reload
                </button>
            </div>
        </div>

        <div class="frameWrap" aria-label="Content frame container">
            <iframe id="contentFrame" name="contentFrame" title="Service content frame"></iframe>
        </div>

        <footer role="contentinfo">
            Keyboard: <b>Tab</b> to move, <b>Enter</b> to open, <b>Shift+Tab</b> to go back.
        </footer>
    </main>
</div>

<script src="app.js"></script>
</body>
</html>
      color: var(--text);
      background:
        radial-gradient(1100px 600px at 20% -10%, rgba(99,102,241,.22), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(16,185,129,.14), transparent 55%),
        radial-gradient(900px 500px at 40% 110%, rgba(244,114,182,.12), transparent 55%),
        var(--bg);
    }

    .skip-link{
      position: absolute;
      left: 10px;
      top: 10px;
      transform: translateY(-120%);
      background: rgba(255,255,255,.92);
      color: #111827;
      padding: 10px 12px;
      border-radius: 10px;
      text-decoration: none;
      font-weight: 700;
      box-shadow: var(--shadow);
      z-index: 9999;
    }
    .skip-link:focus{ transform: translateY(0); outline: none; }

    /* 98% width + minimal side padding */
    .app{
      height: 100%;
      width: 98vw;
      margin: 0 auto;
      padding: 14px 8px;
      display: grid;
      grid-template-columns: 310px 1fr;
      gap: 14px;
    }

    .sidebar{
      position: sticky;
      top: 14px;
      align-self: start;
      height: calc(100vh - 28px);
      overflow: auto;

      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding: 16px;
    }

    .brand{
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 14px;
    }
    .logo{
      width: 40px;
      height: 40px;
      border-radius: 14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(99,102,241,.95), rgba(99,102,241,.35) 55%, rgba(255,255,255,.06) 70%),
        rgba(255,255,255,.05);
      border: 1px solid var(--border);
      box-shadow: 0 10px 25px rgba(99,102,241,.12);
      flex: 0 0 auto;
    }
    .brand h1{ margin: 0; font-size: 15px; letter-spacing: .2px; }
    .brand p{ margin: 2px 0 0 0; font-size: 12px; color: var(--muted); }

    .navtitle{
      font-size: 12px;
      color: var(--muted);
      margin: 12px 0 8px;
      letter-spacing: .2px;
    }

    .navlist{ display: grid; gap: 10px; }

    .navlink{
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: var(--text);
      text-decoration: none;
      font-weight: 650;
      font-size: 13px;
      line-height: 1;
      white-space: nowrap;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      cursor: pointer;
    }
    .navlink:hover{
      background: rgba(255,255,255,.07);
      border-color: rgba(255,255,255,.16);
      transform: translateY(-1px);
    }
    .navlink:focus{
      outline: none;
      box-shadow: var(--ring);
      border-color: rgba(99,102,241,.55);
    }
    .navlink[aria-current="page"]{
      background: rgba(99,102,241,.14);
      border-color: rgba(99,102,241,.35);
    }

    .icon{
      width: 18px;
      height: 18px;
      display: inline-block;
      border-radius: 6px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.12);
      position: relative;
      flex: 0 0 auto;
    }
    .icon::after{
      content: "";
      position: absolute;
      inset: 4px;
      border-radius: 4px;
      background: rgba(255,255,255,.18);
    }

    .pill{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      width: fit-content;
      margin-top: 14px;
      color: var(--muted);
      font-size: 12px;
    }
    .dot{
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(16,185,129,.95);
      box-shadow: 0 0 0 3px rgba(16,185,129,.18);
    }

    /* Content area */
    main{
      min-width: 0;
      height: calc(100vh - 28px);
      overflow: hidden;
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 10px;
      align-self: start;
    }

    .contentHeader{
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(255,255,255,.05);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding: 12px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .contentHeader .title{ margin: 0; font-size: 14px; letter-spacing: .2px; }
    .contentHeader .subtitle{ margin: 3px 0 0 0; font-size: 12px; color: var(--muted); }

    .toolbar{
      display: inline-flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .toolbtn{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      text-decoration: none;
      font-weight: 700;
      font-size: 12px;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      cursor: pointer;
    }
    .toolbtn:hover{
      background: rgba(255,255,255,.09);
      border-color: rgba(255,255,255,.16);
      transform: translateY(-1px);
    }
    .toolbtn:focus{
      outline: none;
      box-shadow: var(--ring);
      border-color: rgba(99,102,241,.55);
    }

    .frameWrap{
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(255,255,255,.05);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow: hidden;
      display: grid;
      min-height: 0;
    }

    /* IMPORTANT: make actuator readable (it usually has dark text) */
    iframe{
      width: 100%;
      height: 100%;
      border: 0;
      background: #ffffff;
    }

    footer{
      color: var(--muted-2);
      font-size: 12px;
      padding: 0 6px;
    }

    /* ---------- Home screen (inside iframe via srcdoc) ---------- */
    .homeWrap{
      height: 100%;
      display: grid;
      place-items: center;
      padding: 28px;
      background:
        radial-gradient(800px 500px at 30% 10%, rgba(99,102,241,.20), transparent 60%),
        radial-gradient(600px 420px at 85% 60%, rgba(16,185,129,.14), transparent 60%),
        #0b1020;
      color: rgba(255,255,255,.92);
      font-family: var(--font);
    }
    .homeCard{
      width: min(860px, 100%);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      background: rgba(255,255,255,.05);
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      padding: 26px 24px;
      overflow: hidden;
      position: relative;
    }
    .homeTitle{
      margin: 0;
      font-size: 22px;
      letter-spacing: .2px;
    }
    .homeSub{
      margin: 8px 0 0 0;
      color: rgba(255,255,255,.72);
      font-size: 13px;
      line-height: 1.5;
    }

    /* rolling machine animation */
    .machine{
      margin-top: 20px;
      display: grid;
      gap: 14px;
    }
    .belt{
      height: 16px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      position: relative;
      overflow: hidden;
    }
    .belt::before{
      content: "";
      position: absolute;
      inset: -40% -60%;
      background: repeating-linear-gradient(
        45deg,
        rgba(255,255,255,.22) 0 10px,
        rgba(255,255,255,.06) 10px 20px
      );
      animation: beltMove 2.2s linear infinite;
      opacity: .9;
    }

    .rollers{
      display: flex;
      align-items: center;
      gap: 18px;
    }
    .roller{
      width: 56px;
      height: 56px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.18), rgba(255,255,255,.06) 60%),
        rgba(255,255,255,.05);
      position: relative;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      animation: spin 1.1s linear infinite;
    }
    .roller::after{
      content: "";
      position: absolute;
      inset: 9px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
    }
    .roller.small{
      width: 42px;
      height: 42px;
      animation-duration: .9s;
      opacity: .95;
    }

    .statusLine{
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: rgba(255,255,255,.72);
      font-size: 12px;
    }
    .pulse{
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: rgba(16,185,129,.95);
      box-shadow: 0 0 0 0 rgba(16,185,129,.35);
      animation: pulse 1.4s ease-out infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes beltMove { to { transform: translateX(20%); } }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(16,185,129,.35); }
      70% { box-shadow: 0 0 0 12px rgba(16,185,129,0); }
      100% { box-shadow: 0 0 0 0 rgba(16,185,129,0); }
    }

    /* Responsive */
    @media (max-width: 920px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ position: relative; top: auto; height: auto; overflow: visible; }
      main{ height: auto; overflow: visible; grid-template-rows: auto auto auto; }
      .frameWrap{ height: 70vh; }
    }

    @media (prefers-reduced-motion: reduce){
      * { transition: none !important; animation: none !important; }
    }
  </style>
</head>

<body>
<a class="skip-link" href="#main">Skip to content</a>

<div class="app">
    <aside class="sidebar" aria-label="Always visible navigation">
        <div class="brand">
            <div class="logo" aria-hidden="true"></div>
            <div>
                <h1>Service Console</h1>
                <p>Navigation stays visible</p>
            </div>
        </div>

        <div class="navtitle">Main</div>
        <div class="navlist">
            <a class="navlink" href="#home" data-title="Home" data-inframe="home">
                <span class="icon" aria-hidden="true"></span>
                Home
            </a>

            <a class="navlink" href="/" data-title="Eureka Dashboard" data-inframe="url">
                <span class="icon" aria-hidden="true"></span>
                Eureka Dashboard
            </a>

            <!-- Bitrix cannot be iframed due to CSP frame-ancestors 'self' -->
            <a class="navlink" href="https://b24-pp3j32.bitrix24.in/~Yr03Z" data-title="Task Management" data-inframe="blocked">
                <span class="icon" aria-hidden="true"></span>
                Task Management
            </a>
        </div>

        <div class="navtitle">Info</div>
        <div class="navlist">
            <a class="navlink" href="/actuator/health" data-title="Actuator Health" data-inframe="url">
                <span class="icon" aria-hidden="true"></span>
                Actuator Health
            </a>

            <a class="navlink" href="/actuator" data-title="Actuator Root" data-inframe="url">
                <span class="icon" aria-hidden="true"></span>
                Actuator Root
            </a>

            <!-- Styled Eureka view (recommended) -->
            <a class="navlink" href="#eurekaStyled" data-title="Eureka Apps (Styled)" data-inframe="eurekaStyled">
                <span class="icon" aria-hidden="true"></span>
                Eureka Apps (Styled)
            </a>

            <!-- Raw Eureka Apps (original) -->
            <a class="navlink" href="/eureka/apps" data-title="Eureka Apps (Raw)" data-inframe="url">
                <span class="icon" aria-hidden="true"></span>
                Eureka Apps (Raw)
            </a>
        </div>

        <div class="pill" title="Local environment status">
            <span class="dot" aria-hidden="true"></span>
            Local console ready
        </div>

        <div style="margin-top: 12px; color: var(--muted); font-size: 12px; line-height: 1.45;">
            Tip: If you want <b>/home/</b> to work (instead of <b>/home/index.html</b>),
            add a small redirect controller. Otherwise, link directly to <b>/home/index.html</b>.
        </div>
    </aside>

    <main id="main" role="main" aria-label="Content frame">
        <div class="contentHeader" role="region" aria-label="Frame header">
            <div>
                <div class="title" id="frameTitle">Home</div>
                <div class="subtitle" id="frameSubtitle">Welcome screen</div>
            </div>

            <div class="toolbar" aria-label="Frame toolbar">
                <button class="toolbtn" type="button" id="openNewTabBtn" title="Open current frame URL in a new tab">
                    ↗ Open in new tab
                </button>
                <button class="toolbtn" type="button" id="reloadBtn" title="Reload the frame">
                    ↻ Reload
                </button>
            </div>
        </div>

        <div class="frameWrap" aria-label="Content frame container">
            <iframe id="contentFrame" name="contentFrame" title="Service content frame"></iframe>
        </div>

        <footer role="contentinfo">
            Keyboard: <b>Tab</b> to move, <b>Enter</b> to open, <b>Shift+Tab</b> to go back.
        </footer>
    </main>
</div>

<script>
(function () {
  const frame = document.getElementById('contentFrame');
  const titleEl = document.getElementById('frameTitle');
  const subEl = document.getElementById('frameSubtitle');
  const openNewTabBtn = document.getElementById('openNewTabBtn');
  const reloadBtn = document.getElementById('reloadBtn');
  const navLinks = Array.from(document.querySelectorAll('.navlink'));

  const PAGE_CSS = document.querySelector('style').innerHTML;

  const HOME_SRCDOC = `
<!doctype html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Home</title><style>${PAGE_CSS}</style></head><body>
<div class="homeWrap" role="region" aria-label="Welcome screen">
  <div class="homeCard">
    <h2 class="homeTitle">Welcome to Service Console</h2>
    <p class="homeSub">Pick any option from the left navigation.</p>
    <div class="machine" aria-label="Rolling machine animation">
      <div class="rollers" aria-hidden="true">
        <div class="roller"></div><div class="roller small"></div><div class="roller"></div>
      </div>
      <div class="belt" aria-hidden="true"></div>
      <div class="statusLine">
        <span class="pulse" aria-hidden="true"></span>
        Console ready • services loading smoothly
      </div>
    </div>
  </div>
</div>
</body></html>`;

  function blockedEmbedDoc(url, title) {
    return `<!doctype html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>${escapeHtml(title)}</title>
<style>${PAGE_CSS}</style></head><body>
  <div class="homeWrap">
    <div class="homeCard">
      <h2 class="homeTitle">${escapeHtml(title)} can’t be shown inside this frame</h2>
      <p class="homeSub">
        Bitrix blocks embedding using Content Security Policy:
        <b style="color: rgba(255,255,255,.92)">frame-ancestors 'self'</b>.
        So the browser blocks it in an iframe.
      </p>
      <a class="toolbtn" href="${escapeAttr(url)}" target="_blank" rel="noopener noreferrer"
         style="display:inline-flex; margin-top:14px; text-decoration:none;">
        ↗ Open ${escapeHtml(title)} in a new tab
      </a>
      <div style="margin-top:10px; color: rgba(255,255,255,.58); font-size:12px;">
        Your left navigation stays available here.
      </div>
    </div>
  </div>
</body></html>`;
  }

  function eurekaStyledDoc(apps) {
    const cards = apps.map(app => {
      const rows = app.instances.map(inst => {
        const urls = [
          inst.homePageUrl ? `<a href="${escapeAttr(inst.homePageUrl)}" target="_blank" rel="noopener noreferrer">Home</a>` : '',
          inst.statusPageUrl ? `<a href="${escapeAttr(inst.statusPageUrl)}" target="_blank" rel="noopener noreferrer">Status</a>` : '',
          inst.healthCheckUrl ? `<a href="${escapeAttr(inst.healthCheckUrl)}" target="_blank" rel="noopener noreferrer">Health</a>` : ''
        ].filter(Boolean).join(' • ');

        const metaKeys = Object.keys(inst.metadata || {});
        const meta = metaKeys.length
          ? `<div style="margin-top:8px; color: rgba(255,255,255,.58); font-size:12px;">
               <b style="color: rgba(255,255,255,.72);">Metadata:</b>
               ${metaKeys.slice(0, 10).map(k => `
                 <span style="margin-right:10px; display:inline-block; margin-top:6px;">
                   <code style="background:rgba(255,255,255,.08);padding:2px 6px;border-radius:8px;border:1px solid rgba(255,255,255,.10);">${escapeHtml(k)}</code>
                   ${escapeHtml(inst.metadata[k])}
                 </span>`).join('')}
               ${metaKeys.length > 10 ? `<div style="margin-top:6px;">(+${metaKeys.length - 10} more)</div>` : ''}
             </div>`
          : '';

        return `
          <div style="border:1px solid rgba(255,255,255,.12); border-radius:14px; padding:14px; background: rgba(255,255,255,.04);">
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
              <div style="font-weight:900; letter-spacing:.2px;">${escapeHtml(inst.id || inst.instanceId || '')}</div>
              <span class="pill" style="margin:0; font-size:12px;">${escapeHtml(inst.status || 'UNKNOWN')}</span>
              ${inst.host ? `<span class="pill" style="margin:0; font-size:12px;">${escapeHtml(inst.host)}</span>` : ''}
              ${inst.ip ? `<span class="pill" style="margin:0; font-size:12px;">${escapeHtml(inst.ip)}</span>` : ''}
              ${inst.port ? `<span class="pill" style="margin:0; font-size:12px;">Port: ${escapeHtml(inst.port)}</span>` : ''}
              ${inst.securePort ? `<span class="pill" style="margin:0; font-size:12px;">Secure: ${escapeHtml(inst.securePort)}</span>` : ''}
            </div>
            <div style="margin-top:8px; color: rgba(255,255,255,.72); font-size:13px; line-height:1.45;">
              ${urls || '<span style="color: rgba(255,255,255,.58);">No URLs exposed</span>'}
            </div>
            ${meta}
          </div>
        `;
      }).join('');

      return `
        <div style="border:1px solid rgba(255,255,255,.12); border-radius:18px; padding:16px; background: rgba(255,255,255,.05);">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
            <div style="font-size:16px; font-weight:1000; letter-spacing:.3px;">${escapeHtml(app.name)}</div>
            <div style="color: rgba(255,255,255,.72); font-size:12px;">Instances:
              <b style="color: rgba(255,255,255,.92);">${app.instances.length}</b>
            </div>
          </div>
          <div style="margin-top:12px; display:grid; gap:10px;">
            ${rows}
          </div>
        </div>
      `;
    }).join('');

    return `<!doctype html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Eureka Apps (Styled)</title>
<style>${PAGE_CSS}</style>
</head><body>
  <div class="homeWrap" style="place-items:stretch; padding:18px;">
    <div class="homeCard" style="width:100%; padding:18px;">
      <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:14px; flex-wrap:wrap;">
        <div>
          <h2 class="homeTitle" style="font-size:18px;">Eureka Apps (Styled)</h2>
          <p class="homeSub" style="margin-top:6px;">Fetched from <b>/eureka/apps</b> (JSON) and rendered nicely.</p>
        </div>
        <button class="toolbtn" style="border:none;" onclick="location.reload()">↻ Refresh</button>
      </div>

      <div style="margin-top:14px; display:grid; gap:14px;">
        ${cards || `<div style="color: rgba(255,255,255,.72);">No applications found.</div>`}
      </div>
    </div>
  </div>
</body></html>`;
  }

  function escapeHtml(s) {
    return String(s ?? '').replace(/[&<>"']/g, c => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[c]));
  }
  function escapeAttr(s) { return escapeHtml(s); }

  function setActive(link) {
    navLinks.forEach(a => a.removeAttribute('aria-current'));
    link.setAttribute('aria-current', 'page');
  }

  function loadHome(link) {
    frame.removeAttribute('src');
    frame.srcdoc = HOME_SRCDOC;
    titleEl.textContent = link.getAttribute('data-title') || 'Home';
    subEl.textContent = 'Welcome screen';
    setActive(link);
  }

  function loadUrl(link) {
    const href = link.getAttribute('href');
    const label = link.getAttribute('data-title') || link.textContent.trim();

    frame.removeAttribute('srcdoc');
    frame.src = href;

    titleEl.textContent = label;
    subEl.textContent = 'Loaded inside the frame';
    setActive(link);
  }

  function loadBlocked(link) {
    const href = link.getAttribute('href');
    const label = link.getAttribute('data-title') || link.textContent.trim();

    frame.removeAttribute('src');
    frame.srcdoc = blockedEmbedDoc(href, label);

    titleEl.textContent = label;
    subEl.textContent = 'Opens in a new tab (embedding blocked)';
    setActive(link);
  }

  async function loadEurekaStyled(link) {
    const label = link.getAttribute('data-title') || link.textContent.trim();
    titleEl.textContent = label;
    subEl.textContent = 'Fetching /eureka/apps …';
    setActive(link);

    frame.removeAttribute('src');
    frame.srcdoc = `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
      <style>${PAGE_CSS}</style></head><body>
      <div class="homeWrap"><div class="homeCard">
        <h2 class="homeTitle">Loading Eureka Apps…</h2>
        <p class="homeSub">Fetching <b>/eureka/apps</b> (JSON) and formatting it.</p>
        <div class="machine"><div class="belt" aria-hidden="true"></div></div>
      </div></div></body></html>`;

    try {
      const res = await fetch('/eureka/apps', { headers: { 'Accept': 'application/json' } });
      if (!res.ok) throw new Error('HTTP ' + res.status);

      const data = await res.json();

      // Expected: { applications: { application: [ { name, instance: [...] } ] } }
      const appList = (data && data.applications && data.applications.application)
        ? data.applications.application
        : [];

      const normalized = appList.map(app => {
        const instancesRaw = Array.isArray(app.instance) ? app.instance : (app.instance ? [app.instance] : []);
        const instances = instancesRaw.map(inst => ({
          id: inst.instanceId || inst.id || '',
          status: inst.status || inst.overriddenStatus || 'UNKNOWN',
          host: inst.hostName || inst.host || '',
          ip: inst.ipAddr || inst.ip || '',
          port: (inst.port && (inst.port['$'] ?? inst.port)) || '',
          securePort: (inst.securePort && (inst.securePort['$'] ?? inst.securePort)) || '',
          homePageUrl: inst.homePageUrl || '',
          statusPageUrl: inst.statusPageUrl || '',
          healthCheckUrl: inst.healthCheckUrl || '',
          metadata: inst.metadata || {}
        }));
        return { name: app.name || 'UNKNOWN_APP', instances };
      });

      frame.removeAttribute('src');
      frame.srcdoc = eurekaStyledDoc(normalized);
      subEl.textContent = 'Loaded (styled)';
    } catch (err) {
      frame.removeAttribute('src');
      frame.srcdoc = `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
        <style>${PAGE_CSS}</style></head><body>
        <div class="homeWrap"><div class="homeCard">
          <h2 class="homeTitle">Could not load Eureka Apps</h2>
          <p class="homeSub">
            Tried <b>GET /eureka/apps</b> with <b>Accept: application/json</b>.
            Error: <b>${escapeHtml(String(err))}</b>
          </p>
          <p class="homeSub" style="margin-top:10px;">
            If your Eureka doesn’t support JSON, use <b>Eureka Apps (Raw)</b>,
            or tell me what format you get (XML/HTML) and I’ll adapt the parser.
          </p>
        </div></div></body></html>`;
      subEl.textContent = 'Failed to load';
    }
  }

  navLinks.forEach(link => {
    link.addEventListener('click', function (e) {
      e.preventDefault();
      const mode = link.getAttribute('data-inframe') || 'url';

      if (mode === 'home' || link.getAttribute('href') === '#home') loadHome(link);
      else if (mode === 'blocked') loadBlocked(link);
      else if (mode === 'eurekaStyled') loadEurekaStyled(link);
      else loadUrl(link);
    });

    link.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        link.click();
      }
    });
  });

  openNewTabBtn.addEventListener('click', function () {
    // Only works for real URLs (srcdoc has no URL)
    const url = frame.getAttribute('src');
    if (url) window.open(url, '_blank', 'noopener,noreferrer');
  });

  reloadBtn.addEventListener('click', function () {
    const active = navLinks.find(a => a.getAttribute('aria-current') === 'page');
    const mode = active ? (active.getAttribute('data-inframe') || 'url') : 'url';

    if (mode === 'home') return loadHome(active || navLinks[0]);
    if (mode === 'blocked') return loadBlocked(active);
    if (mode === 'eurekaStyled') return loadEurekaStyled(active);

    try { frame.contentWindow.location.reload(); }
    catch (e) { frame.src = frame.src; }
  });

  // Initial load: Home
  const homeLink = navLinks.find(a => (a.getAttribute('data-inframe') === 'home') || a.getAttribute('href') === '#home') || navLinks[0];
  loadHome(homeLink);
})();
</script>

</body>
</html>
