<div class="form-container">
  <div class="header">
    <h1>{{ isEditMode ? 'Edit Department' : 'Add New Department' }}</h1>
    <button mat-icon-button (click)="goBack()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <mat-card>
    <mat-card-content>
      <form [formGroup]="departmentForm" (ngSubmit)="onSubmit()">
        <div class="form-grid">
          <!-- Department Code -->
          <mat-form-field appearance="outline">
            <mat-label>Department Code</mat-label>
            <input matInput formControlName="departmentCode" placeholder="e.g., CS, ENG" maxlength="20">
            <mat-error *ngIf="hasError('departmentCode', 'required')">Department Code is required</mat-error>
            <mat-error *ngIf="hasError('departmentCode', 'maxlength')">Maximum 20 characters allowed</mat-error>
          </mat-form-field>

          <!-- Department Name -->
          <mat-form-field appearance="outline">
            <mat-label>Department Name</mat-label>
            <input matInput formControlName="departmentName" placeholder="e.g., Computer Science" maxlength="100">
            <mat-error *ngIf="hasError('departmentName', 'required')">Department Name is required</mat-error>
            <mat-error *ngIf="hasError('departmentName', 'maxlength')">Maximum 100 characters allowed</mat-error>
          </mat-form-field>

          <!-- Department Type -->
          <mat-form-field appearance="outline">
            <mat-label>Department Type</mat-label>
            <mat-select formControlName="departmentType">
              <mat-option *ngFor="let type of departmentTypes" [value]="type">
                {{ type }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="hasError('departmentType', 'required')">Department Type is required</mat-error>
          </mat-form-field>

          <!-- Head of Department (HOD) -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Head of Department (HOD)</mat-label>
            <mat-select formControlName="hodStaffId" [disabled]="!departmentForm.get('departmentType')?.value || loadingStaff">
              <mat-option [value]="null">-- None --</mat-option>
              <mat-option *ngFor="let staff of staffList" [value]="staff.id">
                {{ staff.employeeCode }} - {{ staff.firstName }} {{ staff.lastName }} ({{ staff.email }})
              </mat-option>
            </mat-select>
            <mat-hint *ngIf="!departmentForm.get('departmentType')?.value">Select Department Type first to load staff</mat-hint>
            <mat-hint *ngIf="loadingStaff">Loading staff...</mat-hint>
            <mat-hint *ngIf="departmentForm.get('departmentType')?.value && staffList.length === 0 && !loadingStaff">
              No active staff found for this department type
            </mat-hint>
          </mat-form-field>
        </div>

        <!-- Description (Full Width) -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Description</mat-label>
          <textarea matInput formControlName="description" rows="4" placeholder="Department description" maxlength="500"></textarea>
          <mat-hint align="end">{{ departmentForm.get('description')?.value?.length || 0 }}/500</mat-hint>
          <mat-error *ngIf="hasError('description', 'maxlength')">Maximum 500 characters allowed</mat-error>
        </mat-form-field>

        <!-- Action Buttons -->
        <div class="form-actions">
          <button mat-button type="button" (click)="goBack()">Cancel</button>
          <button mat-raised-button color="primary" type="submit" [disabled]="loading">
            <mat-spinner *ngIf="loading" diameter="20"></mat-spinner>
            <span *ngIf="!loading">{{ isEditMode ? 'Update' : 'Create' }} Department</span>
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>
