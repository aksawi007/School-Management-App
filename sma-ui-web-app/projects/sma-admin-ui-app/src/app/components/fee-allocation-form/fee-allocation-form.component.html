<div class="fee-allocation-form-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>Allocate Fee to Student</mat-card-title>
      <mat-card-subtitle>Manually assign fee to a specific student</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="allocationForm" (ngSubmit)="onSubmit()">
        <!-- Student Selection -->
        <div class="form-section">
          <h3>Student Information</h3>
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Student ID *</mat-label>
              <input matInput type="number" formControlName="studentId" placeholder="Enter student ID">
              <mat-error *ngIf="f['studentId'].hasError('required')">
                Student ID is required
              </mat-error>
              <mat-hint>Enter the student's unique ID</mat-hint>
            </mat-form-field>
          </div>
        </div>

        <!-- Fee Details -->
        <div class="form-section">
          <h3>Fee Details</h3>
          <div class="form-row">
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Fee Category *</mat-label>
              <mat-select formControlName="feeCategoryId">
                <mat-option *ngFor="let category of feeCategories" [value]="category.id">
                  {{ category.categoryName }} ({{ category.categoryType }})
                </mat-option>
              </mat-select>
              <mat-error *ngIf="f['feeCategoryId'].hasError('required')">
                Fee category is required
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Fee Amount *</mat-label>
              <input matInput type="number" formControlName="feeAmount" placeholder="0.00" step="0.01">
              <span matPrefix>₹&nbsp;</span>
              <mat-error *ngIf="f['feeAmount'].hasError('required')">
                Fee amount is required
              </mat-error>
              <mat-error *ngIf="f['feeAmount'].hasError('min')">
                Amount must be greater than 0
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Duration Type *</mat-label>
              <mat-select formControlName="durationType">
                <mat-option *ngFor="let type of durationTypes" [value]="type">
                  {{ type.replace('_', ' ') }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="f['durationType'].hasError('required')">
                Duration type is required
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field" *ngIf="showMonthField()">
              <mat-label>Applicable Month *</mat-label>
              <mat-select formControlName="applicableMonth">
                <mat-option *ngFor="let month of months" [value]="month">
                  {{ month }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="f['applicableMonth'].hasError('required')">
                Month is required for MONTHLY duration
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field" *ngIf="showQuarterField()">
              <mat-label>Quarter *</mat-label>
              <mat-select formControlName="quarter">
                <mat-option *ngFor="let quarter of quarters" [value]="quarter">
                  {{ quarter }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="f['quarter'].hasError('required')">
                Quarter is required for QUARTERLY duration
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Due Date *</mat-label>
              <input matInput [matDatepicker]="dueDatePicker" formControlName="dueDate">
              <mat-datepicker-toggle matSuffix [for]="dueDatePicker"></mat-datepicker-toggle>
              <mat-datepicker #dueDatePicker></mat-datepicker>
              <mat-error *ngIf="f['dueDate'].hasError('required')">
                Due date is required
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Payment Deadline</mat-label>
              <input matInput [matDatepicker]="deadlinePicker" formControlName="paymentDeadline">
              <mat-datepicker-toggle matSuffix [for]="deadlinePicker"></mat-datepicker-toggle>
              <mat-datepicker #deadlinePicker></mat-datepicker>
              <mat-hint>Final deadline for payment</mat-hint>
            </mat-form-field>
          </div>

          <div class="form-row checkbox-row">
            <mat-checkbox formControlName="isMandatory" color="primary">
              Mandatory Fee
            </mat-checkbox>
            <mat-hint>This fee is mandatory for the student</mat-hint>
          </div>
        </div>

        <!-- Discount Section -->
        <div class="form-section">
          <h3>Discount (Optional)</h3>
          <div class="form-row">
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Discount Amount</mat-label>
              <input matInput type="number" formControlName="discountAmount" placeholder="0.00" step="0.01">
              <span matPrefix>₹&nbsp;</span>
              <mat-error *ngIf="f['discountAmount'].hasError('min')">
                Discount cannot be negative
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field" *ngIf="showDiscountReason()">
              <mat-label>Discount Reason *</mat-label>
              <input matInput formControlName="discountReason" placeholder="e.g., Scholarship, Merit">
              <mat-hint>Reason for discount is required when discount is applied</mat-hint>
            </mat-form-field>
          </div>
        </div>

        <!-- Remarks -->
        <div class="form-section">
          <h3>Additional Information</h3>
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Remarks</mat-label>
              <textarea matInput formControlName="remarks" 
                        rows="3" 
                        placeholder="Additional notes or comments"></textarea>
              <mat-error *ngIf="f['remarks'].hasError('maxlength')">
                Maximum 500 characters allowed
              </mat-error>
            </mat-form-field>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button mat-raised-button type="button" (click)="onCancel()" [disabled]="loading">
            Cancel
          </button>
          <button mat-raised-button color="primary" type="submit" [disabled]="loading || allocationForm.invalid">
            <mat-spinner *ngIf="loading" diameter="20"></mat-spinner>
            <span *ngIf="!loading">Allocate Fee</span>
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>
