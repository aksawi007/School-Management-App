<div class="routine-builder-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>Class Routine Builder</mat-card-title>
    </mat-card-header>
    
    <mat-card-content>
      <!-- Filters -->
      <div class="filters-row">
        <mat-form-field appearance="outline">
          <mat-label>Select Academic Year</mat-label>
          <mat-select [(ngModel)]="selectedAcademicYearId" (selectionChange)="onAcademicYearChange()">
            <mat-option *ngFor="let year of academicYears" [value]="year.yearId">
              {{ year.yearName }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Class</mat-label>
          <mat-select [(ngModel)]="selectedClassId" (selectionChange)="onClassChange()">
            <mat-option *ngFor="let cls of classes" [value]="cls.id">
              {{ cls.className }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Section</mat-label>
          <mat-select [(ngModel)]="selectedSectionId" (selectionChange)="onSectionChange()">
            <mat-option *ngFor="let section of sections" [value]="section.id">
              {{ section.sectionName }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <button mat-raised-button 
                color="primary" 
                (click)="showWeekSummary()"
                [disabled]="!selectedAcademicYearId || !selectedClassId || !selectedSectionId || routineData.length === 0"
                class="summary-button">
          <mat-icon>summarize</mat-icon>
          Show Week Summary
        </button>
      </div>

      <!-- Routine Grid -->
      <div *ngIf="!loading && selectedAcademicYearId && selectedClassId && selectedSectionId" class="routine-grid">
        <div class="grid-header">
          <div class="time-slot-header">Time Slots</div>
          <div class="day-header" *ngFor="let day of daysOfWeek">
            {{ day.substring(0, 3) }}
          </div>
        </div>

        <div class="grid-body">
          <div class="grid-row" *ngFor="let timeSlot of timeSlots; let slotIndex = index">
            <div class="time-slot-cell">
              <div class="slot-name">{{ timeSlot.slotName }}</div>
              <div class="slot-time">{{ timeSlot.startTime }} - {{ timeSlot.endTime }}</div>
            </div>

            <div class="routine-cell" 
                 *ngFor="let day of daysOfWeek; let dayIndex = index"
                 (click)="openRoutineDialog(getRoutineCell(dayIndex, slotIndex))">
              <div *ngIf="getRoutineCell(dayIndex, slotIndex)?.routine" 
                   class="routine-entry">
                <div class="subject-name">
                  {{ getRoutineCell(dayIndex, slotIndex)?.routine?.subject?.subjectName || 'Unknown' }}
                </div>
                <div class="teacher-name">
                  {{ getTeacherName(getRoutineCell(dayIndex, slotIndex)?.routine?.teacher) || 'TBD' }}
                </div>
                <button mat-icon-button 
                        class="delete-btn"
                        (click)="deleteRoutine(getRoutineCell(dayIndex, slotIndex)); $event.stopPropagation()">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
              <div *ngIf="!getRoutineCell(dayIndex, slotIndex)?.routine" 
                   class="empty-cell">
                <mat-icon>add</mat-icon>
                <span>Add</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="loading" class="loading-container">
        <mat-spinner></mat-spinner>
      </div>

      <div *ngIf="!selectedAcademicYearId || !selectedClassId || !selectedSectionId" class="no-selection">
        <mat-icon>info</mat-icon>
        <p>Please select Academic Year, Class, and Section to view/edit routine</p>
      </div>
    </mat-card-content>
  </mat-card>
</div>
