# Fee Management Service Design

## Overview
This document describes the fee management system for the School Management Application. The design allows admin to:
1. Create core fee category structures applicable throughout every year
2. Manually allocate fees to specific students based on category, duration, and month

---

## Architecture

### Entity Structure

#### 1. **FeeCategory** (Core Structure - Already Exists)
The foundation of fee management - defines types of fees applicable every year.

**Location:** `sma-jpa-postgresql/src/main/java/org/sma/jpa/model/fee/FeeCategory.java`

**Purpose:** Core fee structure that remains consistent across academic years

**Key Fields:**
- `categoryCode`: Unique code (e.g., TUITION, TRANSPORT, LIBRARY)
- `categoryName`: Display name (e.g., "Tuition Fee", "Transport Fee")
- `categoryType`: TUITION, TRANSPORT, LIBRARY, EXAM, MISCELLANEOUS
- `isMandatory`: Whether this fee is mandatory for all students
- `isRefundable`: Whether this fee can be refunded
- `displayOrder`: Order in which fees are displayed
- `description`: Detailed description

**Usage:** Admin creates these once, reuses every year

---

#### 2. **FeeStructure** (Already Exists)
Defines fee amounts and rules for specific academic years.

**Location:** `sma-jpa-postgresql/src/main/java/org/sma/jpa/model/fee/FeeStructure.java`

**Key Fields:**
- `structureCode`: Unique code for the structure
- `structureName`: Name (e.g., "2024-2025 Fee Structure")
- `academicYear`: Links to specific academic year
- `applicableFor`: ALL, SPECIFIC_CLASS, SPECIFIC_CATEGORY
- `structureStatus`: DRAFT, ACTIVE, INACTIVE

---

#### 3. **FeeComponent** (Already Exists)
Individual fee items within a structure (breakdown by class/category).

**Location:** `sma-jpa-postgresql/src/main/java/org/sma/jpa/model/fee/FeeComponent.java`

**Key Fields:**
- `feeStructure`: Parent structure
- `feeCategory`: Links to core category
- `classMaster`: Optional - specific to class
- `amount`: Fee amount
- `frequency`: MONTHLY, QUARTERLY, HALF_YEARLY, ANNUAL, ONE_TIME
- `dueDay`: Day of month when due
- `lateFeeApplicable`: Whether late fee applies
- `lateFeeAmount`: Late fee amount
- `discountPercentage`: Default discount

---

#### 4. **StudentFeeAllocation** (NEW)
Manual fee assignment to specific students by admin.

**Location:** `sma-jpa-postgresql/src/main/java/org/sma/jpa/model/fee/StudentFeeAllocation.java`

**Purpose:** Admin can manually insert fee details for specific students

**Key Fields:**

**Identification:**
- `allocationCode`: Unique code (SFA-SCHOOL-2024-000001)
- `student`: Student reference
- `feeCategory`: Which fee category
- `feeStructure`: Optional - linked structure

**Amount Details:**
- `feeAmount`: Total fee amount
- `paidAmount`: Amount already paid
- `pendingAmount`: Remaining amount
- `discountAmount`: Discount given
- `lateFeeAmount`: Late fee applied

**Duration & Period:**
- `durationType`: MONTHLY, QUARTERLY, HALF_YEARLY, ANNUAL, ONE_TIME
- `applicableMonth`: JANUARY, FEBRUARY, etc. (for MONTHLY)
- `quarter`: Q1, Q2, Q3, Q4 (for QUARTERLY)
- `dueDate`: When payment is due
- `paymentDeadline`: Final deadline

**Status:**
- `allocationStatus`: PENDING, PAID, PARTIALLY_PAID, OVERDUE, WAIVED, CANCELLED
- `allocationDate`: When fee was allocated
- `autoGenerated`: false for manual allocations

**Audit:**
- `allocatedBy`: Staff/Admin who allocated
- `remarks`: Additional notes

---

## Service Layer

### 1. FeeCategoryBusinessService
Manages core fee categories applicable every year.

**Location:** `sma-admin-core-app/src/main/java/org/sma/admin/core/app/service/FeeCategoryBusinessService.java`

**Key Methods:**

```java
// Create core fee category
FeeCategoryResponse createFeeCategory(Long schoolId, FeeCategoryRequest request)

// Update existing category
FeeCategoryResponse updateFeeCategory(UUID categoryId, FeeCategoryRequest request)

// Get category by ID
FeeCategoryResponse getFeeCategoryById(UUID categoryId)

// Get all active categories
List<FeeCategoryResponse> getAllActiveFeeCategories(Long schoolId)

// Get categories by type (TUITION, TRANSPORT, etc.)
List<FeeCategoryResponse> getFeeCategoriesByType(Long schoolId, String categoryType)

// Activate/Deactivate category
void deactivateFeeCategory(UUID categoryId)
void activateFeeCategory(UUID categoryId)
```

---

### 2. StudentFeeAllocationBusinessService
Handles manual fee allocation to students.

**Location:** `sma-admin-core-app/src/main/java/org/sma/admin/core/app/service/StudentFeeAllocationBusinessService.java`

**Key Methods:**

```java
// Manually allocate fee to student
StudentFeeAllocationResponse allocateFeeToStudent(
    Long schoolId, 
    UUID academicYearId, 
    StudentFeeAllocationRequest request, 
    Long allocatedBy)

// Get student's fee allocations for a year
List<StudentFeeAllocationResponse> getStudentFeeAllocations(
    Long studentId, 
    UUID academicYearId)

// Get pending fees for student
List<StudentFeeAllocationResponse> getPendingFeeAllocations(Long studentId)

// Get overdue fees for school
List<StudentFeeAllocationResponse> getOverdueFeeAllocations(
    Long schoolId, 
    UUID academicYearId)

// Get fees for specific month
List<StudentFeeAllocationResponse> getFeeAllocationsByMonth(
    Long schoolId, 
    UUID academicYearId, 
    String month)

// Calculate total pending amount
BigDecimal calculateTotalPendingAmount(Long studentId, UUID academicYearId)

// Update status (for payments)
StudentFeeAllocationResponse updateAllocationStatus(
    UUID allocationId, 
    String status, 
    BigDecimal paidAmount)

// Cancel allocation
void cancelFeeAllocation(UUID allocationId, String reason)
```

---

## REST API Endpoints

### Fee Category API

**Base URL:** `/api/fee-category`

#### Create Fee Category
```http
POST /api/fee-category/create?schoolId={schoolId}
Content-Type: application/json

{
  "categoryCode": "TUITION",
  "categoryName": "Tuition Fee",
  "categoryType": "TUITION",
  "isMandatory": true,
  "isRefundable": false,
  "displayOrder": 1,
  "description": "Monthly tuition fee for all students"
}
```

#### Update Fee Category
```http
PUT /api/fee-category/update/{categoryId}
Content-Type: application/json

{
  "categoryCode": "TUITION",
  "categoryName": "Tuition Fee (Updated)",
  ...
}
```

#### Get Active Categories
```http
GET /api/fee-category/list/active?schoolId={schoolId}
```

#### Get Categories by Type
```http
GET /api/fee-category/list/by-type?schoolId={schoolId}&categoryType=TUITION
```

#### Deactivate/Activate
```http
PUT /api/fee-category/deactivate/{categoryId}
PUT /api/fee-category/activate/{categoryId}
```

---

### Student Fee Allocation API

**Base URL:** `/api/student-fee-allocation`

#### Allocate Fee to Student
```http
POST /api/student-fee-allocation/allocate?schoolId={schoolId}&academicYearId={yearId}&allocatedBy={adminId}
Content-Type: application/json

{
  "studentId": 12345,
  "feeCategoryId": "uuid-of-fee-category",
  "feeStructureId": "uuid-of-structure",  // Optional
  "feeAmount": 5000.00,
  "durationType": "MONTHLY",
  "applicableMonth": "JANUARY",
  "dueDate": "2024-01-10",
  "paymentDeadline": "2024-01-15",
  "isMandatory": true,
  "discountAmount": 500.00,
  "discountReason": "Scholarship",
  "remarks": "Special case allocation"
}
```

**Duration Types:**
- `MONTHLY`: Requires `applicableMonth` (JANUARY, FEBRUARY, etc.)
- `QUARTERLY`: Requires `quarter` (Q1, Q2, Q3, Q4)
- `HALF_YEARLY`: No month/quarter needed
- `ANNUAL`: No month/quarter needed
- `ONE_TIME`: No month/quarter needed

#### Get Student Fee Allocations
```http
GET /api/student-fee-allocation/student/{studentId}?academicYearId={yearId}
```

**Response:**
```json
[
  {
    "id": "uuid",
    "allocationCode": "SFA-SCH001-2024-000001",
    "studentId": 12345,
    "studentName": "John Doe",
    "studentRollNumber": "2024-001",
    "feeCategoryName": "Tuition Fee",
    "feeCategoryType": "TUITION",
    "feeAmount": 5000.00,
    "durationType": "MONTHLY",
    "applicableMonth": "JANUARY",
    "dueDate": "2024-01-10",
    "allocationStatus": "PENDING",
    "paidAmount": 0.00,
    "pendingAmount": 4500.00,
    "discountAmount": 500.00,
    "academicYear": "2024-2025"
  }
]
```

#### Get Pending Fees
```http
GET /api/student-fee-allocation/student/{studentId}/pending
```

#### Get Overdue Fees
```http
GET /api/student-fee-allocation/overdue?schoolId={schoolId}&academicYearId={yearId}
```

#### Get Fees by Month
```http
GET /api/student-fee-allocation/by-month?schoolId={schoolId}&academicYearId={yearId}&month=JANUARY
```

#### Calculate Total Pending
```http
GET /api/student-fee-allocation/student/{studentId}/total-pending?academicYearId={yearId}
```

**Response:** `4500.00`

#### Update Payment Status
```http
PUT /api/student-fee-allocation/update-status/{allocationId}?status=PARTIALLY_PAID&paidAmount=2000.00
```

**Status Values:**
- `PENDING`: Not paid
- `PARTIALLY_PAID`: Some amount paid
- `PAID`: Fully paid
- `OVERDUE`: Past due date
- `WAIVED`: Waived by admin
- `CANCELLED`: Cancelled

#### Cancel Allocation
```http
DELETE /api/student-fee-allocation/cancel/{allocationId}?reason=Wrong allocation
```

---

## Usage Workflow

### Setup Phase (Done Once Per School)

1. **Create Fee Categories**
   ```
   Admin creates core categories:
   - TUITION (Tuition Fee)
   - TRANSPORT (Transport Fee)
   - LIBRARY (Library Fee)
   - EXAM (Examination Fee)
   - MISCELLANEOUS (Miscellaneous Fees)
   ```

2. **Create Fee Structure** (Already implemented)
   ```
   Define fee structure for academic year
   Link fee components to categories
   ```

### Manual Allocation Phase (Admin Operation)

3. **Allocate Fee to Student**
   ```
   Admin manually assigns fee to student:
   - Select student
   - Choose fee category (e.g., TUITION)
   - Set amount (e.g., â‚¹5000)
   - Choose duration (MONTHLY/QUARTERLY/etc.)
   - Set applicable month (if MONTHLY)
   - Set due date
   - Apply discount if needed
   - Add remarks
   ```

4. **Monitor Fees**
   ```
   Admin can view:
   - All fees for a student
   - Pending fees
   - Overdue fees
   - Fees by month
   - Total pending amount
   ```

---

## Business Logic

### Automatic Calculations

1. **Pending Amount Calculation:**
   ```
   Pending Amount = Fee Amount - Discount Amount - Paid Amount
   ```

2. **Status Auto-Update:**
   - When `paidAmount` > 0 and < (feeAmount - discountAmount): `PARTIALLY_PAID`
   - When `paidAmount` = (feeAmount - discountAmount): `PAID`
   - When `dueDate` < currentDate and status = PENDING: `OVERDUE`

3. **Allocation Code Generation:**
   ```
   Format: SFA-{SCHOOL_CODE}-{YEAR}-{SEQUENCE}
   Example: SFA-SCH001-2024-000001
   ```

### Validation Rules

1. **Duration & Period Validation:**
   - MONTHLY requires `applicableMonth`
   - QUARTERLY requires `quarter`
   - HALF_YEARLY, ANNUAL, ONE_TIME should NOT have month/quarter

2. **Discount Validation:**
   - Discount cannot exceed fee amount
   - Discount reason required if discount > 0

3. **Cancellation Rules:**
   - Cannot cancel if payment already made
   - Reason required for cancellation

---

## Database Schema

### student_fee_allocation
```sql
CREATE TABLE sma_admin.student_fee_allocation (
    id UUID PRIMARY KEY,
    school_id BIGINT NOT NULL,
    academic_year_id UUID NOT NULL,
    student_id BIGINT NOT NULL,
    fee_category_id UUID NOT NULL,
    fee_structure_id UUID,
    allocation_code VARCHAR(50) UNIQUE NOT NULL,
    fee_amount DECIMAL(10, 2) NOT NULL,
    duration_type VARCHAR(20),
    applicable_month VARCHAR(10),
    quarter VARCHAR(10),
    due_date DATE NOT NULL,
    allocation_date DATE NOT NULL,
    allocation_status VARCHAR(20) NOT NULL,
    paid_amount DECIMAL(10, 2) DEFAULT 0,
    pending_amount DECIMAL(10, 2),
    discount_amount DECIMAL(10, 2) DEFAULT 0,
    discount_reason VARCHAR(300),
    late_fee_amount DECIMAL(10, 2) DEFAULT 0,
    late_fee_applied_date DATE,
    payment_deadline DATE,
    is_mandatory BOOLEAN NOT NULL DEFAULT true,
    auto_generated BOOLEAN NOT NULL DEFAULT false,
    remarks VARCHAR(500),
    allocated_by BIGINT,
    is_active BOOLEAN DEFAULT true,
    created_date TIMESTAMP,
    updated_date TIMESTAMP,
    
    CONSTRAINT fk_sfa_school FOREIGN KEY (school_id) REFERENCES sma_admin.school_profile(school_id),
    CONSTRAINT fk_sfa_year FOREIGN KEY (academic_year_id) REFERENCES sma_admin.academic_year(id),
    CONSTRAINT fk_sfa_student FOREIGN KEY (student_id) REFERENCES sma_student.student_basic_info(student_id),
    CONSTRAINT fk_sfa_category FOREIGN KEY (fee_category_id) REFERENCES sma_admin.fee_category(id),
    CONSTRAINT fk_sfa_structure FOREIGN KEY (fee_structure_id) REFERENCES sma_admin.fee_structure(id)
);

-- Indexes for performance
CREATE INDEX idx_sfa_student ON sma_admin.student_fee_allocation(student_id);
CREATE INDEX idx_sfa_school_year ON sma_admin.student_fee_allocation(school_id, academic_year_id);
CREATE INDEX idx_sfa_category ON sma_admin.student_fee_allocation(fee_category_id);
CREATE INDEX idx_sfa_status ON sma_admin.student_fee_allocation(allocation_status);
CREATE INDEX idx_sfa_due_date ON sma_admin.student_fee_allocation(due_date);
```

---

## Example Scenarios

### Scenario 1: Monthly Tuition Fee
```json
{
  "studentId": 12345,
  "feeCategoryId": "tuition-uuid",
  "feeAmount": 5000.00,
  "durationType": "MONTHLY",
  "applicableMonth": "JANUARY",
  "dueDate": "2024-01-10",
  "isMandatory": true
}
```

### Scenario 2: Quarterly Transport Fee
```json
{
  "studentId": 12345,
  "feeCategoryId": "transport-uuid",
  "feeAmount": 3000.00,
  "durationType": "QUARTERLY",
  "quarter": "Q1",
  "dueDate": "2024-04-01",
  "isMandatory": false
}
```

### Scenario 3: One-Time Exam Fee with Discount
```json
{
  "studentId": 12345,
  "feeCategoryId": "exam-uuid",
  "feeAmount": 2000.00,
  "durationType": "ONE_TIME",
  "dueDate": "2024-03-01",
  "discountAmount": 200.00,
  "discountReason": "Merit scholarship",
  "isMandatory": true
}
```

---

## Integration Points

### Existing Functionality
- Links to `FeeCategory` (core structure)
- Links to `FeeStructure` (optional)
- Links to `StudentBasicInfo`
- Links to `AcademicYear`
- Links to `SchoolProfile`

### Future Integration
- **Payment Module**: Update payment status when payment received
- **Late Fee Automation**: Auto-apply late fees after grace period
- **Notification Service**: Send reminders for due fees
- **Report Generation**: Fee collection reports, pending reports
- **Auto-Generation**: Bulk fee allocation based on class/section

---

## Summary

This design provides:

1. **Core Fee Category Structure**: Reusable fee categories applicable every year
2. **Manual Fee Allocation**: Admin can insert fee details for specific students
3. **Flexible Duration**: MONTHLY, QUARTERLY, HALF_YEARLY, ANNUAL, ONE_TIME
4. **Month/Quarter Based**: Allocate fees for specific months or quarters
5. **Discount Support**: Apply discounts with reasons
6. **Status Tracking**: PENDING, PAID, PARTIALLY_PAID, OVERDUE, etc.
7. **Payment Integration**: Track paid/pending amounts
8. **Reporting**: Overdue fees, pending fees, month-wise fees
9. **Audit Trail**: Track who allocated and when

The system is designed to be flexible, allowing admins to manually manage fees while maintaining a structured approach with core categories that remain consistent across years.
